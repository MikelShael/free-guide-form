<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Download Your Free Guide</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
      .hidden {
        display: none;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Get Your Free Guide</h1>
    <button id="fb-login-btn">Login with Facebook</button>

    <div id="form-container" class="hidden">
      <form id="guide-form">
        <label for="name">Name:</label><br />
        <input type="text" id="name" name="name" required /><br /><br />

        <label for="email">Email:</label><br />
        <input type="email" id="email" name="email" required /><br /><br />

        <label for="phone">Phone Number:</label><br />
        <input type="tel" id="phone" name="phone" required /><br /><br />

        <label for="birthday">Birthday:</label><br />
        <input type="date" id="birthday" name="birthday" required /><br /><br />

        <input type="hidden" id="facebookId" name="facebookId" />

        <button type="submit">Download Guide</button>
      </form>
      <p id="status"></p>
    </div>

    <!-- Facebook SDK -->
    <script
      async
      defer
      crossorigin="anonymous"
      src="https://connect.facebook.net/en_US/sdk.js"
    ></script>

    <script>
      // Initialize Facebook SDK
      window.fbAsyncInit = function () {
        FB.init({
          appId: "1275271937046910",
          cookie: true,
          xfbml: true,
          version: "v17.0", // Use the latest version
        });

        FB.AppEvents.logPageView();
      };

      document
        .getElementById("fb-login-btn")
        .addEventListener("click", function () {
          FB.login(
            function (response) {
              if (response.authResponse) {
                FB.api(
                  "/me",
                  { fields: "name, birthday" },
                  function (response) {
                    document.getElementById("name").value = response.name || "";
                    document.getElementById("birthday").value =
                      response.birthday
                        ? response.birthday.split("/").reverse().join("-")
                        : "";
                    document.getElementById("facebookId").value =
                      response.id || "";
                    document.getElementById("fb-login-btn").style.display =
                      "none";
                    document
                      .getElementById("form-container")
                      .classList.remove("hidden");
                  }
                );
              } else {
                alert("User cancelled login or did not fully authorize.");
              }
            },
            { scope: "public_profile,user_birthday,email" }
          );
        });

      document
        .getElementById("guide-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const data = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            birthday: document.getElementById("birthday").value,
            facebookId: document.getElementById("facebookId").value,
          };

          fetch(
            "https://script.google.com/macros/s/AKfycbz8gN4PGwZmnDS3DoVPBcE8JZjTc5Zuh6yVWctQtKTW0yrZkFPPeblsyCVfTnx6kGiwAA/exec",
            {
              method: "POST",
              mode: "no-cors", // Because Google Apps Script might not have CORS enabled
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          )
            .then(() => {
              document.getElementById("status").innerText =
                "Thank you! Your guide is downloading...";
              // Optionally, redirect to the guide download link
              window.location.href =
                "https://docs.google.com/spreadsheets/d/15WYIa8_JAzYTvhh8ZIMVi-9mkvxSaX6lMQFjpaeluq0/edit?usp=sharing";
            })
            .catch((error) => {
              console.error("Error:", error);
              document.getElementById("status").innerText =
                "An error occurred. Please try again.";
            });
        });
    </script>
  </body>
</html>
